<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Bot Manager - Batch Mode</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 900px;
    }

    .card {
      border: none;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      margin-bottom: 20px;
    }

    .card-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 15px 15px 0 0 !important;
      font-weight: 600;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
    }

    #loading {
      display: none;
    }

    .spinner-border {
      width: 1.5rem;
      height: 1.5rem;
    }

    .data-item {
      padding: 15px;
      background: #f8f9fa;
      border-radius: 10px;
      margin-bottom: 10px;
    }

    .data-label {
      font-weight: 600;
      color: #6c757d;
      font-size: 0.85rem;
      text-transform: uppercase;
    }

    .data-value {
      font-size: 1.1rem;
      color: #212529;
      margin-top: 5px;
    }

    .progress-badge {
      font-size: 1.2rem;
      padding: 10px 20px;
      border-radius: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="text-center mb-4">
      <h1 class="text-white mb-2"><i class="bi bi-robot"></i> Batch Bot Manager</h1>
      <p class="text-white-50">Claim and process all unclaimed SQs - Discrepancy Refund System</p>
      <div class="mb-2">
        <button class="btn btn-sm btn-outline-light" onclick="clearCacheAndRestart()">
          <i class="bi bi-arrow-clockwise"></i> Clear Cache & Restart
        </button>
        <button class="btn btn-sm btn-outline-light" onclick="showLocalStorageInfo()">
          <i class="bi bi-info-circle"></i> Show Saved Progress
        </button>
      </div>
      <small id="progressInfo" class="text-white-50"></small>
    </div>

    <!-- Loading Indicator -->
    <div id="loading" class="text-center mb-4">
      <div class="spinner-border text-white" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="text-white mt-2" id="loadingText">Processing...</p>
    </div>

    <!-- Step 1: Claim Batch -->
    <div id="claimBatchCard" class="card">
      <div class="card-header">
        <h4 class="mb-0"><i class="bi bi-download"></i> Step 1: Claim Next Batch</h4>
      </div>
      <div class="card-body">
        <p class="text-muted">Claim ALL unclaimed SQs from the Discrepancy Log and load them into the Helper Doc</p>
        <button id="claimBtn" class="btn btn-primary btn-lg w-100 mb-2" onclick="claimBatch()">
          <i class="bi bi-cloud-download"></i> Claim All Unclaimed SQs
        </button>
        <button id="resumeBtn" class="btn btn-outline-primary btn-lg w-100" onclick="resumeFromHelperDoc()">
          <i class="bi bi-folder-open"></i> Resume from Helper Doc
        </button>
        <small class="text-muted d-block mt-2">
          ‚è±Ô∏è Claiming may take 2-6 minutes depending on quantity. Apps Script timeout: 6 minutes.<br>
          üí° Use "Resume" if Helper Doc already has SQs from a previous session.<br>
          üéØ System will claim as many SQs as possible within timeout limit.
        </small>
      </div>
    </div>

    <!-- Step 2: Process Each SQ -->
    <div id="processSQCard" class="card" style="display: none;">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h4 class="mb-0"><i class="bi bi-file-text"></i> Step 2: Process Each SQ</h4>
        <span id="progressBadge" class="progress-badge">SQ 1 of 20</span>
      </div>
      <div class="card-body">
        <!-- Current SQ Info -->
        <div class="alert alert-info mb-3">
          <strong>Current SQ:</strong> <span id="currentSQNumber">-</span>
          <span class="float-end">
            <strong>Total Rows:</strong> <span id="currentSQRowCount">-</span>
          </span>
        </div>

        <!-- SQ Data Display -->
        <div id="sqDataDisplay" class="mb-3">
          <h6 class="fw-bold mb-2">Card Data (First Row Preview):</h6>
          <div class="row">
            <div class="col-md-6">
              <div class="data-item">
                <div class="data-label">Game</div>
                <div class="data-value" id="game">-</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="data-item">
                <div class="data-label">Card Name</div>
                <div class="data-value" id="cardName">-</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="data-item">
                <div class="data-label">Set</div>
                <div class="data-value" id="setName">-</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="data-item">
                <div class="data-label">Condition</div>
                <div class="data-value" id="condition">-</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <button id="openSqBtn" class="btn btn-outline-primary btn-lg w-100 mb-2" onclick="openCurrentSqLink()">
          <i class="bi bi-box-arrow-up-right"></i> Open SQ Link
        </button>

        <!-- PDF Upload -->
        <div class="card mb-3">
          <div class="card-header bg-info text-white">
            <h6 class="mb-0"><i class="bi bi-file-pdf"></i> Upload PDF (Optional)</h6>
          </div>
          <div class="card-body">
            <div class="upload-area" style="border: 2px dashed #ccc; padding: 20px; text-align: center; cursor: pointer;" onclick="document.getElementById('fileInput').click()">
              <i class="bi bi-cloud-upload" style="font-size: 2rem; color: #6c757d;"></i>
              <p class="mt-2 mb-0">Click to upload PDF for current SQ</p>
              <input type="file" id="fileInput" accept=".pdf" style="display:none" onchange="uploadPDF()">
            </div>
            <div id="uploadStatus" style="display: none; padding: 10px; margin-top: 10px;"></div>
          </div>
        </div>

        <!-- Manual Data Entry (if needed) -->
        <div id="manualDataCard" class="card mb-3" style="display: none;">
          <div class="card-header bg-warning text-dark">
            <h6 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Fill Missing Information</h6>
          </div>
          <div class="card-body">
            <p class="text-muted">Some rows for this SQ are missing Order Number or Buyer Name. Please fill them in:</p>
            <div id="manualFields"></div>
            <button class="btn btn-warning w-100 mt-3" onclick="syncManualData()">
              <i class="bi bi-arrow-repeat"></i> Save Manual Data
            </button>
          </div>
        </div>

        <!-- Next SQ Button -->
        <div class="d-grid gap-2">
          <button id="nextSqBtn" class="btn btn-success btn-lg" onclick="nextSQ()" disabled>
            <i class="bi bi-arrow-right"></i> Next SQ
          </button>
          <small class="text-muted text-center" id="nextSqHint">Complete all required fields to proceed</small>
        </div>
      </div>
    </div>

    <!-- Step 3: Upload Batch -->
    <div id="uploadBatchCard" class="card" style="display: none;">
      <div class="card-header bg-success text-white">
        <h4 class="mb-0"><i class="bi bi-cloud-upload"></i> Step 3: Upload All to Refund Log</h4>
      </div>
      <div class="card-body">
        <div class="alert alert-success mb-3">
          <i class="bi bi-check-circle"></i> <strong>All SQs Processed!</strong>
          <p class="mb-0">Ready to upload <span id="totalRowsToUpload">0</span> rows from <span id="totalSQsToUpload">0</span> SQs to the Refund Log.</p>
        </div>
        <button id="uploadBtn" class="btn btn-success btn-lg w-100 mb-2" onclick="uploadBatchToRefundLog()">
          <i class="bi bi-upload"></i> Upload All to Refund Log
        </button>
        <button class="btn btn-secondary w-100" onclick="startNewBatch()">
          <i class="bi bi-arrow-clockwise"></i> Start New Batch
        </button>
      </div>
    </div>
  </div>

  <script>
    // State variables
    let sqNumbersList = []; // Array of SQ numbers to process (e.g., ["251019-137rmb", ...])
    let sqRowRanges = {}; // Map of SQ numbers to row ranges {sqNumber: {startRow, endRow}} for fast loading
    let currentSQData = null; // Currently loaded SQ data {sqNumber, sqLink, rowCount, rows: [...]}
    let currentSQIndex = 0; // Which SQ we're currently processing (0-19)
    let totalSQsInBatch = 0;
    const BOT_ID = 'BATCH_BOT'; // Single bot for batch processing

    // Restore state from localStorage on page load (persists across browser sessions)
    window.addEventListener('load', function() {
      const savedSQList = localStorage.getItem('sqNumbersList');
      const savedIndex = localStorage.getItem('currentSQIndex');
      const savedCurrentSQ = localStorage.getItem('currentSQData');

      if (savedSQList && savedIndex) {
        sqNumbersList = JSON.parse(savedSQList);
        currentSQIndex = parseInt(savedIndex);
        totalSQsInBatch = sqNumbersList.length;

        if (savedCurrentSQ) {
          currentSQData = JSON.parse(savedCurrentSQ);
        }

        // Restore UI state
        if (currentSQIndex < totalSQsInBatch) {
          document.getElementById('claimBatchCard').style.display = 'none';
          document.getElementById('processSQCard').style.display = 'block';

          if (currentSQData) {
            displayCurrentSQ();
          } else {
            // Load current SQ if not in cache
            loadSingleSQAndDisplay(currentSQIndex);
          }
        } else {
          // All SQs processed, show upload card
          document.getElementById('claimBatchCard').style.display = 'none';
          document.getElementById('uploadBatchCard').style.display = 'block';
          updateUploadSummary();
        }
      }
    });

    // Save state to localStorage (persists across browser sessions)
    function saveState() {
      localStorage.setItem('sqNumbersList', JSON.stringify(sqNumbersList));
      localStorage.setItem('currentSQIndex', currentSQIndex.toString());
      if (currentSQData) {
        localStorage.setItem('currentSQData', JSON.stringify(currentSQData));
      }
    }

    function clearState() {
      localStorage.removeItem('sqNumbersList');
      localStorage.removeItem('currentSQIndex');
      localStorage.removeItem('currentSQData');
    }

    function showLoading(text) {
      document.getElementById('loadingText').textContent = text;
      document.getElementById('loading').style.display = 'block';
    }

    function hideLoading() {
      document.getElementById('loading').style.display = 'none';
    }

    function claimBatch() {
      showLoading('Claiming all unclaimed SQs... This may take 2-6 minutes depending on quantity. Please wait...');
      document.getElementById('claimBtn').disabled = true;
      document.getElementById('resumeBtn').disabled = true;

      google.script.run
        .withSuccessHandler(function(result) {
          handleClaimSuccess(result);
        })
        .withFailureHandler(function(error) {
          hideLoading();
          alert('Error: ' + error.message);
          document.getElementById('claimBtn').disabled = false;
          document.getElementById('resumeBtn').disabled = false;
        })
        .pullNextBatchOfSQs(BOT_ID, 20); // Claim 20 SQs at a time to keep Helper Doc small and fast
    }

    function resumeFromHelperDoc() {
      // Check if there's existing progress in localStorage
      const savedSQList = localStorage.getItem('sqNumbersList');
      const savedIndex = localStorage.getItem('currentSQIndex');

      console.log('Resume check - savedSQList:', savedSQList);
      console.log('Resume check - savedIndex:', savedIndex);

      if (savedSQList && savedIndex) {
        const savedIndex_int = parseInt(savedIndex);
        const savedSQs = JSON.parse(savedSQList);

        console.log('Found saved progress - Index:', savedIndex_int, 'Total SQs:', savedSQs.length);

        // Only show resume prompt if we haven't finished all SQs yet
        if (savedIndex_int < savedSQs.length) {
          // Ask user if they want to resume from where they left off
          const resumeMsg = `Found existing progress:\n\n` +
            `You were on SQ ${savedIndex_int + 1} of ${savedSQs.length}\n\n` +
            `Click OK to resume from SQ ${savedIndex_int + 1}, or Cancel to start over from SQ 1`;

          if (confirm(resumeMsg)) {
            // Resume from existing progress
            sqNumbersList = savedSQs;
            currentSQIndex = savedIndex_int;
            totalSQsInBatch = savedSQs.length;

            console.log('User chose to resume - Loading SQ', currentSQIndex + 1);

            // Restore UI and load current SQ
            document.getElementById('claimBatchCard').style.display = 'none';
            document.getElementById('processSQCard').style.display = 'block';
            loadSingleSQAndDisplay(currentSQIndex);
            return;
          } else {
            console.log('User chose to start over - clearing state');
            // User chose to start over - clear saved progress
            clearState();
          }
        } else {
          // Already finished all SQs - clear and start fresh
          console.log('All SQs already processed - clearing state');
          clearState();
        }
      } else {
        console.log('No saved progress found');
      }

      // No saved progress or user chose to start over - load fresh from Helper Doc
      showLoading('Loading SQ list from Helper Doc...');
      document.getElementById('claimBtn').disabled = true;
      document.getElementById('resumeBtn').disabled = true;

      // Step 1: Get list of SQ numbers with completion status
      google.script.run
        .withSuccessHandler(function(result) {
          if (!result || !result.success) {
            hideLoading();
            alert(result ? result.message : 'Failed to load SQ list');
            document.getElementById('claimBtn').disabled = false;
            document.getElementById('resumeBtn').disabled = false;
            return;
          }

          // Check if any SQs are already complete
          if (result.completedCount > 0) {
            console.log('Found ' + result.completedCount + ' completed SQ(s), ' + result.incompleteCount + ' incomplete');

            // Show status to user
            const statusMsg = `Found ${result.totalSQs} SQ(s) in Helper Doc:\n\n` +
              `‚úì Completed: ${result.completedCount}\n` +
              `‚óã Incomplete: ${result.incompleteCount}\n\n` +
              `${result.incompleteCount > 0 ?
                'Starting from first incomplete SQ (' + (result.firstIncompleteIndex + 1) + ' of ' + result.totalSQs + ')' :
                'All SQs are complete! Ready to upload.'}`;

            alert(statusMsg);
          }

          // Step 2: Initialize batch and load from first incomplete SQ
          initializeBatchFromSQList(result.sqNumbers, result.sqRowRanges, result.firstIncompleteIndex || 0);
        })
        .withFailureHandler(function(error) {
          hideLoading();
          alert('Error: ' + error.message);
          document.getElementById('claimBtn').disabled = false;
          document.getElementById('resumeBtn').disabled = false;
        })
        .getSQList(BOT_ID);
    }

    /**
     * Initialize batch with SQ list, then load first SQ only
     * Subsequent SQs are loaded on-demand when user clicks "Next SQ"
     * @param {Array} sqNumbers - Array of SQ numbers
     * @param {Object} rowRanges - Map of SQ numbers to row ranges {sqNumber: {startRow, endRow}}
     * @param {Number} startIndex - Index to start from (default 0)
     */
    function initializeBatchFromSQList(sqNumbers, rowRanges, startIndex) {
      console.log('üîç [AUTO-START DEBUG] initializeBatchFromSQList called');
      console.log('üîç [AUTO-START DEBUG] sqNumbers:', sqNumbers);
      console.log('üîç [AUTO-START DEBUG] rowRanges:', rowRanges);
      console.log('üîç [AUTO-START DEBUG] startIndex:', startIndex);

      if (!sqNumbers || sqNumbers.length === 0) {
        console.error('‚ùå [AUTO-START DEBUG] sqNumbers is empty or null');
        hideLoading();
        alert('No SQs found in Helper Doc');
        document.getElementById('claimBtn').disabled = false;
        document.getElementById('resumeBtn').disabled = false;
        return;
      }

      // Handle parameter order: could be (sqNumbers, startIndex) or (sqNumbers, rowRanges, startIndex)
      if (typeof rowRanges === 'number') {
        // Called as (sqNumbers, startIndex) - no rowRanges provided
        startIndex = rowRanges;
        rowRanges = {};
      }

      startIndex = startIndex || 0; // Default to 0 if not provided

      console.log('‚úÖ [AUTO-START DEBUG] Initializing batch with ' + sqNumbers.length + ' SQ(s), starting from index ' + startIndex);

      // Store SQ list, row ranges, and set starting index
      sqNumbersList = sqNumbers;
      sqRowRanges = rowRanges || {}; // Store row range cache for fast loading
      currentSQIndex = startIndex;
      totalSQsInBatch = sqNumbers.length;
      currentSQData = null;

      console.log('üîç [AUTO-START DEBUG] Saving state to localStorage...');
      saveState();

      console.log('üîç [AUTO-START DEBUG] Calling loadSingleSQAndDisplay(' + startIndex + ')...');

      // Load SQ at starting index (might be > 0 if resuming from incomplete)
      loadSingleSQAndDisplay(startIndex);
    }

    /**
     * Load a single SQ by index and display it
     * Called when: (1) Starting batch, (2) Clicking "Next SQ", (3) Page refresh
     */
    function loadSingleSQAndDisplay(index) {
      console.log('üîç [AUTO-START DEBUG] loadSingleSQAndDisplay called with index:', index);
      console.log('üîç [AUTO-START DEBUG] totalSQsInBatch:', totalSQsInBatch);

      if (index >= totalSQsInBatch) {
        console.log('‚ö†Ô∏è [AUTO-START DEBUG] index >= totalSQsInBatch - all SQs processed');
        // All SQs processed
        document.getElementById('processSQCard').style.display = 'none';
        document.getElementById('uploadBatchCard').style.display = 'block';
        updateUploadSummary();
        return;
      }

      const sqNumber = sqNumbersList[index];
      const rowRange = sqRowRanges[sqNumber]; // Get cached row range if available

      console.log('üîç [AUTO-START DEBUG] Loading SQ:', sqNumber);
      console.log('üîç [AUTO-START DEBUG] Row range cache:', rowRange);

      showLoading(`Loading SQ ${index + 1} of ${totalSQsInBatch}: ${sqNumber}...`);

      // Pass row range if available (much faster for large Helper Docs!)
      const scriptCall = google.script.run
        .withSuccessHandler(function(result) {
          console.log('üîç [AUTO-START DEBUG] loadSingleSQ returned:', result);
          hideLoading();

          if (!result || !result.success) {
            console.error('‚ùå [AUTO-START DEBUG] loadSingleSQ failed');
            alert('Failed to load SQ ' + sqNumber + ': ' + (result ? result.message : 'Unknown error'));
            document.getElementById('claimBtn').disabled = false;
            document.getElementById('resumeBtn').disabled = false;
            return;
          }

          console.log('‚úÖ [AUTO-START DEBUG] loadSingleSQ success');

          // Store current SQ data
          currentSQData = result.sqData;
          saveState();

          console.log('‚úÖ [AUTO-START DEBUG] Loaded SQ ' + (index + 1) + '/' + totalSQsInBatch + ':', sqNumber);

          console.log('üîç [AUTO-START DEBUG] Hiding claim card, showing process card...');
          // Hide claim card, show process card
          document.getElementById('claimBatchCard').style.display = 'none';
          document.getElementById('processSQCard').style.display = 'block';
          console.log('‚úÖ [AUTO-START DEBUG] UI cards switched successfully');

          console.log('üîç [AUTO-START DEBUG] Calling displayCurrentSQ()...');
          // Display this SQ
          displayCurrentSQ();

          if (index === 0) {
            console.log('üîç [AUTO-START DEBUG] First SQ - showing welcome alert');
            alert(`Ready to process ${totalSQsInBatch} SQ(s)!\n\nNow processing SQ 1 of ${totalSQsInBatch}`);
          }
        })
        .withFailureHandler(function(error) {
          console.error('‚ùå [AUTO-START DEBUG] loadSingleSQ error:', error);
          hideLoading();
          alert('Error loading SQ ' + sqNumber + ': ' + error.message);
          document.getElementById('claimBtn').disabled = false;
          document.getElementById('resumeBtn').disabled = false;
        });

      // Call with or without row range depending on cache availability
      if (rowRange && rowRange.startRow && rowRange.endRow) {
        console.log('üîç [AUTO-START DEBUG] Calling loadSingleSQ with cached row range (' + rowRange.startRow + '-' + rowRange.endRow + ')');
        scriptCall.loadSingleSQ(BOT_ID, sqNumber, rowRange.startRow, rowRange.endRow);
      } else {
        console.log('üîç [AUTO-START DEBUG] Calling loadSingleSQ without row range (will scan column J)');
        scriptCall.loadSingleSQ(BOT_ID, sqNumber);
      }
    }

    function handleClaimSuccess(result) {
      hideLoading();

      console.log('üîç [AUTO-START DEBUG] handleClaimSuccess called');
      console.log('üîç [AUTO-START DEBUG] result:', result);

      // Check if result is null or undefined
      if (!result) {
        console.error('‚ùå [AUTO-START DEBUG] Result is null or undefined');
        alert('Error: Server returned no data. This usually means the function timed out or crashed. Check Apps Script execution logs.');
        document.getElementById('claimBtn').disabled = false;
        document.getElementById('resumeBtn').disabled = false;
        return;
      }

      console.log('üîç [AUTO-START DEBUG] result.success:', result.success);
      console.log('üîç [AUTO-START DEBUG] result.useResume:', result.useResume);

      if (!result.success) {
        console.error('‚ùå [AUTO-START DEBUG] result.success is false');
        alert(result.message || 'Failed to claim batch');
        document.getElementById('claimBtn').disabled = false;
        document.getElementById('resumeBtn').disabled = false;
        return;
      }

      // NEW: Check if we need to use paginated loading to get full data
      if (result.useResume) {
        console.log('‚úÖ [AUTO-START DEBUG] result.useResume is true - starting auto-load');
        console.log('üîç [AUTO-START DEBUG] Calling getSQList(' + BOT_ID + ')...');
        showLoading('Loading SQ list from Helper Doc...');

        // Step 1: Get list of SQ numbers (lightweight)
        google.script.run
          .withSuccessHandler(function(listResult) {
            console.log('üîç [AUTO-START DEBUG] getSQList returned:', listResult);

            if (!listResult || !listResult.success) {
              console.error('‚ùå [AUTO-START DEBUG] getSQList failed or returned unsuccessful result');
              hideLoading();
              alert('Claim succeeded but failed to load SQ list: ' + (listResult ? listResult.message : 'Unknown error'));
              document.getElementById('claimBtn').disabled = false;
              document.getElementById('resumeBtn').disabled = false;
              return;
            }

            console.log('‚úÖ [AUTO-START DEBUG] getSQList success - sqNumbers:', listResult.sqNumbers);
            console.log('‚úÖ [AUTO-START DEBUG] getSQList returned sqRowRanges:', listResult.sqRowRanges);
            console.log('üîç [AUTO-START DEBUG] Calling initializeBatchFromSQList()...');

            // Step 2: Initialize batch and load first SQ only
            initializeBatchFromSQList(listResult.sqNumbers, listResult.sqRowRanges);
          })
          .withFailureHandler(function(error) {
            console.error('‚ùå [AUTO-START DEBUG] getSQList error:', error);
            hideLoading();
            alert('Claim succeeded but failed to load data: ' + error.message);
            document.getElementById('claimBtn').disabled = false;
            document.getElementById('resumeBtn').disabled = false;
          })
          .getSQList(BOT_ID);
        return;
      } else {
        console.warn('‚ö†Ô∏è [AUTO-START DEBUG] result.useResume is NOT true - auto-start will not happen');
        console.log('üîç [AUTO-START DEBUG] This means the result does not have useResume flag set');
      }

      // All paths now use paginated loading via initializeBatchFromSQList()
    }

    function displayCurrentSQ() {
      if (!currentSQData) {
        console.error('No current SQ data to display');
        return;
      }

      // Update progress badge
      document.getElementById('progressBadge').textContent = `SQ ${currentSQIndex + 1} of ${totalSQsInBatch}`;

      // Update SQ info
      document.getElementById('currentSQNumber').textContent = currentSQData.sqNumber;
      document.getElementById('currentSQRowCount').textContent = currentSQData.rowCount;

      // Display first row as preview
      const firstRow = currentSQData.rows[0];
      document.getElementById('game').textContent = firstRow.game || '-';
      document.getElementById('cardName').textContent = firstRow.cardName || '-';
      document.getElementById('setName').textContent = firstRow.setName || '-';
      document.getElementById('condition').textContent = firstRow.condition || '-';

      // Auto-open SQ link
      if (currentSQData.sqLink) {
        window.open(currentSQData.sqLink, '_blank');
      }

      // Reset upload status
      document.getElementById('uploadStatus').style.display = 'none';
      document.getElementById('manualDataCard').style.display = 'none';

      // Check if this SQ has missing order/buyer data
      // If so, disable "Next SQ" button until PDF is uploaded or manual data is entered
      checkMissingFields();
    }

    function checkMissingFields(showForm) {
      if (!currentSQData) return;

      let hasMissing = false;

      for (const row of currentSQData.rows) {
        if (!row.orderNumber || !row.buyerName) {
          hasMissing = true;
          break;
        }
      }

      if (hasMissing) {
        // Only show manual data form if showForm parameter is true
        // This allows us to check/disable button without showing form on initial load
        if (showForm === true) {
          showManualDataForm();
        }
        document.getElementById('nextSqBtn').disabled = true;
        document.getElementById('nextSqHint').textContent = 'Upload PDF or enter data manually to proceed';
      } else {
        // No missing fields, enable next button and hide manual form
        document.getElementById('nextSqBtn').disabled = false;
        document.getElementById('nextSqHint').textContent = 'Ready to move to next SQ';
        document.getElementById('manualDataCard').style.display = 'none';
      }
    }

    function openCurrentSqLink() {
      if (currentSQData && currentSQData.sqLink) {
        window.open(currentSQData.sqLink, '_blank');
      } else {
        alert('No SQ link available');
      }
    }

    function uploadPDF() {
      const fileInput = document.getElementById('fileInput');
      const file = fileInput.files[0];
      const uploadStatus = document.getElementById('uploadStatus');

      if (!file) return;

      if (!file.name.toLowerCase().endsWith('.pdf')) {
        uploadStatus.style.display = 'block';
        uploadStatus.className = 'alert alert-danger';
        uploadStatus.textContent = 'Please select a PDF file';
        return;
      }

      showLoading('Uploading and processing PDF...');

      uploadStatus.style.display = 'block';
      uploadStatus.className = 'alert alert-info';
      uploadStatus.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>Processing...';

      const reader = new FileReader();
      reader.onload = function(e) {
        const base64Data = e.target.result.split(',')[1];

        if (!currentSQData) {
          uploadStatus.className = 'alert alert-danger';
          uploadStatus.textContent = 'No SQ data loaded';
          return;
        }

        google.script.run
          .withSuccessHandler(handlePDFUploadSuccess)
          .withFailureHandler(handlePDFUploadError)
          .processPDFUpload(BOT_ID, currentSQData.sqNumber, base64Data, file.name);
      };
      reader.readAsDataURL(file);
    }

    function handlePDFUploadSuccess(result) {
      hideLoading();
      const uploadStatus = document.getElementById('uploadStatus');

      if (!result.success) {
        uploadStatus.className = 'alert alert-danger';
        uploadStatus.textContent = 'Error: ' + (result.message || 'Failed to process PDF');
        return;
      }

      uploadStatus.className = 'alert alert-success';
      uploadStatus.innerHTML = '<i class="bi bi-check-circle me-2"></i>' + result.message;

      // Reload SQ data from Helper Doc to get fresh data with order/buyer info
      console.log('PDF processed successfully, reloading SQ data from Helper Doc...');

      showLoading('Refreshing SQ data...');

      google.script.run
        .withSuccessHandler(function(reloadResult) {
          hideLoading();

          if (!reloadResult || !reloadResult.success) {
            console.error('Failed to reload SQ data:', reloadResult);
            uploadStatus.className = 'alert alert-warning';
            uploadStatus.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>' +
              'PDF processed but failed to refresh data. Please click "Next SQ" and come back.';
            return;
          }

          // Update current SQ data with fresh data from Helper Doc
          currentSQData = reloadResult.sqData;
          saveState();

          console.log('Reloaded SQ data after PDF upload:', currentSQData);

          // Check if we still have missing fields, and show manual form if needed
          checkMissingFields(true);  // Pass true to show form after PDF upload
        })
        .withFailureHandler(function(error) {
          hideLoading();
          console.error('Error reloading SQ data:', error);
          uploadStatus.className = 'alert alert-warning';
          uploadStatus.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>' +
            'PDF processed but failed to refresh: ' + error.message;
        })
        .loadSingleSQ(BOT_ID, result.sqNumber);
    }

    function handlePDFUploadError(error) {
      hideLoading();
      const uploadStatus = document.getElementById('uploadStatus');
      uploadStatus.style.display = 'block';
      uploadStatus.className = 'alert alert-danger';
      uploadStatus.textContent = 'Error: ' + error.message;
    }

    function showManualDataForm() {
      const container = document.getElementById('manualFields');
      container.innerHTML = '';

      if (!currentSQData) return;

      console.log('üîç [MANUAL FORM DEBUG] showManualDataForm called with ' + currentSQData.rows.length + ' total rows');
      let displayedCount = 0;

      currentSQData.rows.forEach((row, idx) => {
        const needsOrder = !row.orderNumber;
        const needsBuyer = !row.buyerName;

        console.log('  Row ' + (idx + 1) + ': ' + row.cardName + ' - Order: "' + (row.orderNumber || 'MISSING') + '", Buyer: "' + (row.buyerName || 'MISSING') + '"');

        if (!needsOrder && !needsBuyer) {
          console.log('    ‚Üí Skipping (complete)');
          return; // Skip complete rows
        }

        console.log('    ‚Üí Displaying in form (needsOrder=' + needsOrder + ', needsBuyer=' + needsBuyer + ')');
        displayedCount++;

        const rowDiv = document.createElement('div');
        rowDiv.className = 'card mb-2';
        rowDiv.innerHTML = `
          <div class="card-body">
            <h6 class="card-title fw-bold mb-2">Row ${idx + 1}: ${row.cardName || 'N/A'}</h6>
            <div class="row mb-2">
              <div class="col-6"><small class="text-muted">Set:</small> ${row.setName || 'N/A'}</div>
              <div class="col-3"><small class="text-muted">Qty:</small> ${row.qty || 1}</div>
              <div class="col-3"><small class="text-muted">Cond:</small> ${row.condition || 'N/A'}</div>
            </div>
            ${needsOrder ? `
              <div class="mb-2">
                <label class="form-label fw-bold">Order Number</label>
                <input type="text" class="form-control" data-row="${idx}" data-field="orderNumber" placeholder="Enter order number">
              </div>
            ` : ''}
            ${needsBuyer ? `
              <div class="mb-2">
                <label class="form-label fw-bold">Buyer Name</label>
                <input type="text" class="form-control" data-row="${idx}" data-field="buyerName" placeholder="Enter buyer name">
              </div>
            ` : ''}
          </div>
        `;
        container.appendChild(rowDiv);
      });

      console.log('üîç [MANUAL FORM DEBUG] Displayed ' + displayedCount + ' row(s) with missing data in form');

      if (displayedCount > 0) {
        document.getElementById('manualDataCard').style.display = 'block';
      } else {
        console.log('üîç [MANUAL FORM DEBUG] No missing rows, hiding manual form card');
        document.getElementById('manualDataCard').style.display = 'none';
      }
    }

    function syncManualData() {
      const inputs = document.querySelectorAll('#manualFields input[data-row]');
      let allFilled = true;

      inputs.forEach(input => {
        const rowIdx = parseInt(input.getAttribute('data-row'));
        const field = input.getAttribute('data-field');
        const value = input.value.trim();

        if (!value) {
          allFilled = false;
          input.classList.add('is-invalid');
        } else {
          input.classList.remove('is-invalid');
          // Update the row data in memory
          if (currentSQData) {
            currentSQData.rows[rowIdx][field] = value;
          }
        }
      });

      if (!allFilled) {
        alert('Please fill in all missing fields');
        return;
      }

      if (!currentSQData) {
        alert('No SQ data loaded');
        return;
      }

      showLoading('Saving manual data to Helper Doc...');

      // Save updated rows to Helper Doc
      google.script.run
        .withSuccessHandler(handleManualSyncSuccess)
        .withFailureHandler(handleError)
        .syncAllItemsToHelper(BOT_ID, currentSQData.rows);
    }

    function handleManualSyncSuccess(result) {
      hideLoading();

      if (!result.success) {
        alert(result.message || 'Failed to sync manual data');
        return;
      }

      saveState();

      // Hide manual data form
      document.getElementById('manualDataCard').style.display = 'none';

      // Enable next button
      document.getElementById('nextSqBtn').disabled = false;
      document.getElementById('nextSqHint').textContent = 'Ready to move to next SQ';

      alert('Manual data saved successfully!');
    }

    function nextSQ() {
      // Move to next SQ
      currentSQIndex++;
      currentSQData = null; // Clear current data
      saveState();

      if (currentSQIndex >= totalSQsInBatch) {
        // All SQs processed
        document.getElementById('processSQCard').style.display = 'none';
        document.getElementById('uploadBatchCard').style.display = 'block';
        updateUploadSummary();
      } else {
        // Load next SQ on-demand (using row ranges from sqRowRanges map)
        loadSingleSQAndDisplay(currentSQIndex);
      }
    }

    function updateUploadSummary() {
      // We don't have full data for all SQs, but we know the count
      // The upload will read directly from Helper Doc anyway
      document.getElementById('totalSQsToUpload').textContent = totalSQsInBatch;
      document.getElementById('totalRowsToUpload').textContent = '(counting...)';

      // Get total row count from Helper Doc
      google.script.run
        .withSuccessHandler(function(result) {
          if (result && result.success) {
            document.getElementById('totalRowsToUpload').textContent = result.totalRows || 'unknown';
          }
        })
        .withFailureHandler(function(error) {
          console.error('Failed to get row count:', error);
        })
        .getSQList(BOT_ID);
    }

    function uploadBatchToRefundLog() {
      showLoading('Uploading all SQs to Refund Log...');
      document.getElementById('uploadBtn').disabled = true;

      // Use sqNumbersList (already have all SQ numbers)
      google.script.run
        .withSuccessHandler(handleUploadSuccess)
        .withFailureHandler(handleError)
        .uploadBatchToRefundLog(BOT_ID, sqNumbersList);
    }

    function handleUploadSuccess(result) {
      hideLoading();

      if (!result.success) {
        alert(result.message || 'Failed to upload to Refund Log');
        document.getElementById('uploadBtn').disabled = false;
        return;
      }

      const message = `Successfully uploaded ${result.rows} row(s) from ${result.sqCount} SQ(s) to Refund Log!\n\nReady to claim next batch of 20 SQs.`;
      alert(message);

      // Clear state and reset for new batch
      startNewBatch();
    }

    function startNewBatch() {
      // Clear state
      sqNumbersList = [];
      currentSQData = null;
      currentSQIndex = 0;
      totalSQsInBatch = 0;
      clearState();

      // Reset UI
      document.getElementById('claimBatchCard').style.display = 'block';
      document.getElementById('processSQCard').style.display = 'none';
      document.getElementById('uploadBatchCard').style.display = 'none';
      document.getElementById('claimBtn').disabled = false;
      document.getElementById('resumeBtn').disabled = false;
      document.getElementById('uploadBtn').disabled = false;
    }

    function showLocalStorageInfo() {
      const savedSQList = localStorage.getItem('sqNumbersList');
      const savedIndex = localStorage.getItem('currentSQIndex');

      if (savedSQList && savedIndex) {
        const savedSQs = JSON.parse(savedSQList);
        const index = parseInt(savedIndex);
        alert(`Saved Progress:\n\nCurrent SQ: ${index + 1} of ${savedSQs.length}\n\nSQ List:\n${savedSQs.slice(0, 5).join('\n')}${savedSQs.length > 5 ? '\n...' : ''}`);
      } else {
        alert('No saved progress found in localStorage');
      }
    }

    function clearCacheAndRestart() {
      if (confirm('This will clear all batch progress and start fresh. Are you sure?')) {
        // Clear localStorage
        clearState();

        // Reload the page to start completely fresh
        window.location.reload();
      }
    }

    function handleError(error) {
      hideLoading();
      alert('Error: ' + error.message);
      console.error(error);
    }

    // Warn user if they try to leave with batch in progress
    window.addEventListener('beforeunload', function(e) {
      if (sqNumbersList.length > 0 && currentSQIndex < totalSQsInBatch) {
        e.preventDefault();
        e.returnValue = 'You have a batch in progress. Are you sure you want to leave?';
        return e.returnValue;
      }
    });
  </script>
</body>
</html>
