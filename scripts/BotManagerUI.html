<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Bot Manager - Batch Mode</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 900px;
    }

    .card {
      border: none;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      margin-bottom: 20px;
    }

    .card-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 15px 15px 0 0 !important;
      font-weight: 600;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
    }

    #loading {
      display: none;
    }

    .spinner-border {
      width: 1.5rem;
      height: 1.5rem;
    }

    .data-item {
      padding: 15px;
      background: #f8f9fa;
      border-radius: 10px;
      margin-bottom: 10px;
    }

    .data-label {
      font-weight: 600;
      color: #6c757d;
      font-size: 0.85rem;
      text-transform: uppercase;
    }

    .data-value {
      font-size: 1.1rem;
      color: #212529;
      margin-top: 5px;
    }

    .progress-badge {
      font-size: 1.2rem;
      padding: 10px 20px;
      border-radius: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="text-center mb-4">
      <h1 class="text-white mb-2"><i class="bi bi-robot"></i> Batch Bot Manager</h1>
      <p class="text-white-50">Process 20 SQs at a time - Discrepancy Refund System</p>
    </div>

    <!-- Loading Indicator -->
    <div id="loading" class="text-center mb-4">
      <div class="spinner-border text-white" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="text-white mt-2" id="loadingText">Processing...</p>
    </div>

    <!-- Step 1: Claim Batch -->
    <div id="claimBatchCard" class="card">
      <div class="card-header">
        <h4 class="mb-0"><i class="bi bi-download"></i> Step 1: Claim Next Batch</h4>
      </div>
      <div class="card-body">
        <p class="text-muted">Claim the next 20 unclaimed SQs from the Discrepancy Log and load them into the Helper Doc</p>
        <button id="claimBtn" class="btn btn-primary btn-lg w-100" onclick="claimBatch()">
          <i class="bi bi-cloud-download"></i> Claim Next 20 SQs
        </button>
      </div>
    </div>

    <!-- Step 2: Process Each SQ -->
    <div id="processSQCard" class="card" style="display: none;">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h4 class="mb-0"><i class="bi bi-file-text"></i> Step 2: Process Each SQ</h4>
        <span id="progressBadge" class="progress-badge">SQ 1 of 20</span>
      </div>
      <div class="card-body">
        <!-- Current SQ Info -->
        <div class="alert alert-info mb-3">
          <strong>Current SQ:</strong> <span id="currentSQNumber">-</span>
          <span class="float-end">
            <strong>Total Rows:</strong> <span id="currentSQRowCount">-</span>
          </span>
        </div>

        <!-- SQ Data Display -->
        <div id="sqDataDisplay" class="mb-3">
          <h6 class="fw-bold mb-2">Card Data (First Row Preview):</h6>
          <div class="row">
            <div class="col-md-6">
              <div class="data-item">
                <div class="data-label">Game</div>
                <div class="data-value" id="game">-</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="data-item">
                <div class="data-label">Card Name</div>
                <div class="data-value" id="cardName">-</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="data-item">
                <div class="data-label">Set</div>
                <div class="data-value" id="setName">-</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="data-item">
                <div class="data-label">Condition</div>
                <div class="data-value" id="condition">-</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <button id="openSqBtn" class="btn btn-outline-primary btn-lg w-100 mb-2" onclick="openCurrentSqLink()">
          <i class="bi bi-box-arrow-up-right"></i> Open SQ Link
        </button>

        <!-- PDF Upload -->
        <div class="card mb-3">
          <div class="card-header bg-info text-white">
            <h6 class="mb-0"><i class="bi bi-file-pdf"></i> Upload PDF (Optional)</h6>
          </div>
          <div class="card-body">
            <div class="upload-area" style="border: 2px dashed #ccc; padding: 20px; text-align: center; cursor: pointer;" onclick="document.getElementById('fileInput').click()">
              <i class="bi bi-cloud-upload" style="font-size: 2rem; color: #6c757d;"></i>
              <p class="mt-2 mb-0">Click to upload PDF for current SQ</p>
              <input type="file" id="fileInput" accept=".pdf" style="display:none" onchange="uploadPDF()">
            </div>
            <div id="uploadStatus" style="display: none; padding: 10px; margin-top: 10px;"></div>
          </div>
        </div>

        <!-- Manual Data Entry (if needed) -->
        <div id="manualDataCard" class="card mb-3" style="display: none;">
          <div class="card-header bg-warning text-dark">
            <h6 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Fill Missing Information</h6>
          </div>
          <div class="card-body">
            <p class="text-muted">Some rows for this SQ are missing Order Number or Buyer Name. Please fill them in:</p>
            <div id="manualFields"></div>
            <button class="btn btn-warning w-100 mt-3" onclick="syncManualData()">
              <i class="bi bi-arrow-repeat"></i> Save Manual Data
            </button>
          </div>
        </div>

        <!-- Next SQ Button -->
        <div class="d-grid gap-2">
          <button id="nextSqBtn" class="btn btn-success btn-lg" onclick="nextSQ()" disabled>
            <i class="bi bi-arrow-right"></i> Next SQ
          </button>
          <small class="text-muted text-center" id="nextSqHint">Complete all required fields to proceed</small>
        </div>
      </div>
    </div>

    <!-- Step 3: Upload Batch -->
    <div id="uploadBatchCard" class="card" style="display: none;">
      <div class="card-header bg-success text-white">
        <h4 class="mb-0"><i class="bi bi-cloud-upload"></i> Step 3: Upload All to Refund Log</h4>
      </div>
      <div class="card-body">
        <div class="alert alert-success mb-3">
          <i class="bi bi-check-circle"></i> <strong>All SQs Processed!</strong>
          <p class="mb-0">Ready to upload <span id="totalRowsToUpload">0</span> rows from <span id="totalSQsToUpload">0</span> SQs to the Refund Log.</p>
        </div>
        <button id="uploadBtn" class="btn btn-success btn-lg w-100 mb-2" onclick="uploadBatchToRefundLog()">
          <i class="bi bi-upload"></i> Upload All to Refund Log
        </button>
        <button class="btn btn-secondary w-100" onclick="startNewBatch()">
          <i class="bi bi-arrow-clockwise"></i> Start New Batch
        </button>
      </div>
    </div>
  </div>

  <script>
    // State variables
    let batchedSQs = []; // Array of {sqNumber, sqLink, rowCount, rows: [...]}
    let currentSQIndex = 0; // Which SQ we're currently processing (0-19)
    let totalSQsInBatch = 0;
    const BOT_ID = 'BATCH_BOT'; // Single bot for batch processing

    // Restore state from sessionStorage on page load (in case of refresh)
    window.addEventListener('load', function() {
      const savedBatch = sessionStorage.getItem('batchedSQs');
      const savedIndex = sessionStorage.getItem('currentSQIndex');

      if (savedBatch && savedIndex) {
        batchedSQs = JSON.parse(savedBatch);
        currentSQIndex = parseInt(savedIndex);
        totalSQsInBatch = batchedSQs.length;

        // Restore UI state
        if (currentSQIndex < totalSQsInBatch) {
          document.getElementById('claimBatchCard').style.display = 'none';
          document.getElementById('processSQCard').style.display = 'block';
          displayCurrentSQ();
        } else {
          // All SQs processed, show upload card
          document.getElementById('claimBatchCard').style.display = 'none';
          document.getElementById('uploadBatchCard').style.display = 'block';
          updateUploadSummary();
        }
      }
    });

    // Save state to sessionStorage
    function saveState() {
      sessionStorage.setItem('batchedSQs', JSON.stringify(batchedSQs));
      sessionStorage.setItem('currentSQIndex', currentSQIndex.toString());
    }

    function clearState() {
      sessionStorage.removeItem('batchedSQs');
      sessionStorage.removeItem('currentSQIndex');
    }

    function showLoading(text) {
      document.getElementById('loadingText').textContent = text;
      document.getElementById('loading').style.display = 'block';
    }

    function hideLoading() {
      document.getElementById('loading').style.display = 'none';
    }

    function claimBatch() {
      showLoading('Claiming next 20 SQs... This may take a minute.');
      document.getElementById('claimBtn').disabled = true;

      // Set 3-minute timeout for batch claim
      const claimTimeout = setTimeout(function() {
        hideLoading();
        document.getElementById('claimBtn').disabled = false;
        alert('Batch claim timed out after 3 minutes. The server may be slow. Please try again.');
      }, 180000);

      google.script.run
        .withSuccessHandler(function(result) {
          clearTimeout(claimTimeout);
          handleClaimSuccess(result);
        })
        .withFailureHandler(function(error) {
          clearTimeout(claimTimeout);
          hideLoading();
          alert('Error: ' + error.message);
          document.getElementById('claimBtn').disabled = false;
        })
        .pullNextBatchOfSQs(BOT_ID, 20);
    }

    function handleClaimSuccess(result) {
      hideLoading();

      if (!result.success) {
        alert(result.message || 'Failed to claim batch');
        document.getElementById('claimBtn').disabled = false;
        return;
      }

      // Store batch data
      batchedSQs = result.sqBatch;
      currentSQIndex = 0;
      totalSQsInBatch = batchedSQs.length;

      saveState();

      console.log('Claimed batch:', batchedSQs);

      // Hide claim card, show process card
      document.getElementById('claimBatchCard').style.display = 'none';
      document.getElementById('processSQCard').style.display = 'block';

      // Display first SQ
      displayCurrentSQ();

      alert(`Successfully claimed ${totalSQsInBatch} SQs! (${result.totalRows} total rows)\n\nNow processing SQ 1 of ${totalSQsInBatch}`);
    }

    function displayCurrentSQ() {
      if (currentSQIndex >= totalSQsInBatch) {
        // All SQs processed, move to upload step
        document.getElementById('processSQCard').style.display = 'none';
        document.getElementById('uploadBatchCard').style.display = 'block';
        updateUploadSummary();
        return;
      }

      const currentSQ = batchedSQs[currentSQIndex];

      // Update progress badge
      document.getElementById('progressBadge').textContent = `SQ ${currentSQIndex + 1} of ${totalSQsInBatch}`;

      // Update SQ info
      document.getElementById('currentSQNumber').textContent = currentSQ.sqNumber;
      document.getElementById('currentSQRowCount').textContent = currentSQ.rowCount;

      // Display first row as preview
      const firstRow = currentSQ.rows[0];
      document.getElementById('game').textContent = firstRow.game || '-';
      document.getElementById('cardName').textContent = firstRow.cardName || '-';
      document.getElementById('setName').textContent = firstRow.setName || '-';
      document.getElementById('condition').textContent = firstRow.condition || '-';

      // Auto-open SQ link
      if (currentSQ.sqLink) {
        window.open(currentSQ.sqLink, '_blank');
      }

      // Reset upload status
      document.getElementById('uploadStatus').style.display = 'none';
      document.getElementById('manualDataCard').style.display = 'none';

      // Check if this SQ has missing fields
      checkMissingFields();
    }

    function checkMissingFields() {
      const currentSQ = batchedSQs[currentSQIndex];
      let hasMissing = false;

      for (const row of currentSQ.rows) {
        if (!row.orderNumber || !row.buyerName) {
          hasMissing = true;
          break;
        }
      }

      if (hasMissing) {
        // Show manual data form
        showManualDataForm();
        document.getElementById('nextSqBtn').disabled = true;
        document.getElementById('nextSqHint').textContent = 'Complete all required fields to proceed';
      } else {
        // No missing fields, enable next button
        document.getElementById('nextSqBtn').disabled = false;
        document.getElementById('nextSqHint').textContent = 'Ready to move to next SQ';
      }
    }

    function openCurrentSqLink() {
      const currentSQ = batchedSQs[currentSQIndex];
      if (currentSQ && currentSQ.sqLink) {
        window.open(currentSQ.sqLink, '_blank');
      } else {
        alert('No SQ link available');
      }
    }

    function uploadPDF() {
      const fileInput = document.getElementById('fileInput');
      const file = fileInput.files[0];
      const uploadStatus = document.getElementById('uploadStatus');

      if (!file) return;

      if (!file.name.toLowerCase().endsWith('.pdf')) {
        uploadStatus.style.display = 'block';
        uploadStatus.className = 'alert alert-danger';
        uploadStatus.textContent = 'Please select a PDF file';
        return;
      }

      showLoading('Uploading and processing PDF...');

      uploadStatus.style.display = 'block';
      uploadStatus.className = 'alert alert-info';
      uploadStatus.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>Processing...';

      const reader = new FileReader();
      reader.onload = function(e) {
        const base64Data = e.target.result.split(',')[1];
        const currentSQ = batchedSQs[currentSQIndex];

        google.script.run
          .withSuccessHandler(handlePDFUploadSuccess)
          .withFailureHandler(handlePDFUploadError)
          .processPDFUpload(BOT_ID, currentSQ.sqNumber, base64Data, file.name);
      };
      reader.readAsDataURL(file);
    }

    function handlePDFUploadSuccess(result) {
      hideLoading();
      const uploadStatus = document.getElementById('uploadStatus');

      if (!result.success) {
        uploadStatus.className = 'alert alert-danger';
        uploadStatus.textContent = 'Error: ' + (result.message || 'Failed to process PDF');
        return;
      }

      uploadStatus.className = 'alert alert-success';
      uploadStatus.innerHTML = '<i class="bi bi-check-circle me-2"></i>' + result.message;

      // Update current SQ's rows with data from PDF
      if (result.updatedItems && result.updatedItems.length > 0) {
        batchedSQs[currentSQIndex].rows = result.updatedItems;
        saveState();

        console.log('Updated current SQ after PDF:', batchedSQs[currentSQIndex]);

        // Check if we still have missing fields
        checkMissingFields();
      }
    }

    function handlePDFUploadError(error) {
      hideLoading();
      const uploadStatus = document.getElementById('uploadStatus');
      uploadStatus.style.display = 'block';
      uploadStatus.className = 'alert alert-danger';
      uploadStatus.textContent = 'Error: ' + error.message;
    }

    function showManualDataForm() {
      const container = document.getElementById('manualFields');
      container.innerHTML = '';

      const currentSQ = batchedSQs[currentSQIndex];

      currentSQ.rows.forEach((row, idx) => {
        const needsOrder = !row.orderNumber;
        const needsBuyer = !row.buyerName;

        if (!needsOrder && !needsBuyer) return; // Skip complete rows

        const rowDiv = document.createElement('div');
        rowDiv.className = 'card mb-2';
        rowDiv.innerHTML = `
          <div class="card-body">
            <h6 class="card-title fw-bold mb-2">Row ${idx + 1}: ${row.cardName || 'N/A'}</h6>
            <div class="row mb-2">
              <div class="col-6"><small class="text-muted">Set:</small> ${row.setName || 'N/A'}</div>
              <div class="col-3"><small class="text-muted">Qty:</small> ${row.qty || 1}</div>
              <div class="col-3"><small class="text-muted">Cond:</small> ${row.condition || 'N/A'}</div>
            </div>
            ${needsOrder ? `
              <div class="mb-2">
                <label class="form-label fw-bold">Order Number</label>
                <input type="text" class="form-control" data-row="${idx}" data-field="orderNumber" placeholder="Enter order number">
              </div>
            ` : ''}
            ${needsBuyer ? `
              <div class="mb-2">
                <label class="form-label fw-bold">Buyer Name</label>
                <input type="text" class="form-control" data-row="${idx}" data-field="buyerName" placeholder="Enter buyer name">
              </div>
            ` : ''}
          </div>
        `;
        container.appendChild(rowDiv);
      });

      document.getElementById('manualDataCard').style.display = 'block';
    }

    function syncManualData() {
      const inputs = document.querySelectorAll('#manualFields input[data-row]');
      let allFilled = true;

      inputs.forEach(input => {
        const rowIdx = parseInt(input.getAttribute('data-row'));
        const field = input.getAttribute('data-field');
        const value = input.value.trim();

        if (!value) {
          allFilled = false;
          input.classList.add('is-invalid');
        } else {
          input.classList.remove('is-invalid');
          // Update the row data in memory
          batchedSQs[currentSQIndex].rows[rowIdx][field] = value;
        }
      });

      if (!allFilled) {
        alert('Please fill in all missing fields');
        return;
      }

      showLoading('Saving manual data to Helper Doc...');

      // Save updated rows to Helper Doc
      google.script.run
        .withSuccessHandler(handleManualSyncSuccess)
        .withFailureHandler(handleError)
        .syncAllItemsToHelper(BOT_ID, batchedSQs[currentSQIndex].rows);
    }

    function handleManualSyncSuccess(result) {
      hideLoading();

      if (!result.success) {
        alert(result.message || 'Failed to sync manual data');
        return;
      }

      saveState();

      // Hide manual data form
      document.getElementById('manualDataCard').style.display = 'none';

      // Enable next button
      document.getElementById('nextSqBtn').disabled = false;
      document.getElementById('nextSqHint').textContent = 'Ready to move to next SQ';

      alert('Manual data saved successfully!');
    }

    function nextSQ() {
      // Move to next SQ
      currentSQIndex++;
      saveState();

      if (currentSQIndex >= totalSQsInBatch) {
        // All SQs processed
        document.getElementById('processSQCard').style.display = 'none';
        document.getElementById('uploadBatchCard').style.display = 'block';
        updateUploadSummary();
      } else {
        // Display next SQ
        displayCurrentSQ();
      }
    }

    function updateUploadSummary() {
      let totalRows = 0;
      for (const sq of batchedSQs) {
        totalRows += sq.rowCount;
      }

      document.getElementById('totalRowsToUpload').textContent = totalRows;
      document.getElementById('totalSQsToUpload').textContent = totalSQsInBatch;
    }

    function uploadBatchToRefundLog() {
      showLoading('Uploading all SQs to Refund Log...');
      document.getElementById('uploadBtn').disabled = true;

      // Extract SQ numbers
      const sqNumbers = batchedSQs.map(sq => sq.sqNumber);

      google.script.run
        .withSuccessHandler(handleUploadSuccess)
        .withFailureHandler(handleError)
        .uploadBatchToRefundLog(BOT_ID, sqNumbers);
    }

    function handleUploadSuccess(result) {
      hideLoading();

      if (!result.success) {
        alert(result.message || 'Failed to upload to Refund Log');
        document.getElementById('uploadBtn').disabled = false;
        return;
      }

      const message = `Successfully uploaded ${result.rows} row(s) from ${result.sqCount} SQ(s) to Refund Log!`;
      alert(message);

      // Clear state and reset for new batch
      startNewBatch();
    }

    function startNewBatch() {
      // Clear state
      batchedSQs = [];
      currentSQIndex = 0;
      totalSQsInBatch = 0;
      clearState();

      // Reset UI
      document.getElementById('claimBatchCard').style.display = 'block';
      document.getElementById('processSQCard').style.display = 'none';
      document.getElementById('uploadBatchCard').style.display = 'none';
      document.getElementById('claimBtn').disabled = false;
      document.getElementById('uploadBtn').disabled = false;
    }

    function handleError(error) {
      hideLoading();
      alert('Error: ' + error.message);
      console.error(error);
    }

    // Warn user if they try to leave with batch in progress
    window.addEventListener('beforeunload', function(e) {
      if (batchedSQs.length > 0 && currentSQIndex < totalSQsInBatch) {
        e.preventDefault();
        e.returnValue = 'You have a batch in progress. Are you sure you want to leave?';
        return e.returnValue;
      }
    });
  </script>
</body>
</html>
